!function(a,b,c){b[a]=c()}("h337",this,function(){var a={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},b=function(){var b=function(a){this._coordinator={},this._data=[],this._radi=[],this._min=0,this._max=1,this._xField=a["xField"]||a.defaultXField,this._yField=a["yField"]||a.defaultYField,this._valueField=a["valueField"]||a.defaultValueField,a["radius"]&&(this._cfgRadius=a["radius"])},c=a.defaultRadius;return b.prototype={_organiseData:function(a,b){var d=a[this._xField],e=a[this._yField],f=this._radi,g=this._data,h=this._max,i=this._min,j=a[this._valueField]||1,k=a.radius||this._cfgRadius||c;return g[d]||(g[d]=[],f[d]=[]),g[d][e]?g[d][e]+=j:(g[d][e]=j,f[d][e]=k),g[d][e]>h?(b?this.setDataMax(g[d][e]):this._max=g[d][e],!1):{x:d,y:e,value:j,radius:k,min:i,max:h}},_unOrganizeData:function(){var d,e,a=[],b=this._data,c=this._radi;for(d in b)for(e in b[d])a.push({x:d,y:e,radius:c[d][e],value:b[d][e]});return{min:this._min,max:this._max,data:a}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){var a,b,c;if(arguments[0].length>0)for(a=arguments[0],b=a.length;b--;)this.addData.call(this,a[b]);else c=this._organiseData(arguments[0],!0),c&&this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[c]});return this},setData:function(a){var d,b=a.data,c=b.length;for(this._data=[],this._radi=[],d=0;c>d;d++)this._organiseData(b[d],!1);return this._max=a.max,this._min=a.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(a){return this._max=a,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(a){return this._min=a,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(a){this._coordinator=a},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},b}(),c=function(){function d(b){var g,c=b.element,d=this.shadowCanvas=document.createElement("canvas"),e=this.canvas=b.canvas||document.createElement("canvas");this._renderBoundaries=[1e4,1e4,0,0],g=getComputedStyle(b.element)||{},e.className="heatmap-canvas",this._width=e.width=d.width=+g.width.replace(/px/,""),this._height=e.height=d.height=+g.height.replace(/px/,""),this.shadowCtx=d.getContext("2d"),this.ctx=e.getContext("2d"),e.style.cssText=d.style.cssText="position:absolute;left:0;top:0;",c.style.position="relative",c.appendChild(e),this._palette=a(b),this._templates={},this._setStyles(b)}var a=function(a){var e,f,b=a.gradient||a.defaultGradient,c=document.createElement("canvas"),d=c.getContext("2d");c.width=256,c.height=1,e=d.createLinearGradient(0,0,256,1);for(f in b)e.addColorStop(f,b[f]);return d.fillStyle=e,d.fillRect(0,0,256,1),d.getImageData(0,0,256,1).data},b=function(a,b){var g,c=document.createElement("canvas"),d=c.getContext("2d"),e=a,f=a;return c.width=c.height=2*a,1==b?(d.beginPath(),d.arc(e,f,a,0,2*Math.PI,!1),d.fillStyle="rgba(0,0,0,1)",d.fill()):(g=d.createRadialGradient(e,f,a*b,e,f,a),g.addColorStop(0,"rgba(0,0,0,1)"),g.addColorStop(1,"rgba(0,0,0,0)"),d.fillStyle=g,d.fillRect(0,0,2*a,2*a)),c},c=function(a){var f,g,h,i,j,k,l,m,b=[],c=a.min,d=a.max,e=a.radi;for(a=a.data,f=Object.keys(a),g=f.length;g--;)for(h=f[g],i=Object.keys(a[h]),j=i.length;j--;)k=i[j],l=a[h][k],m=e[h][k],b.push({x:h,y:k,value:l,radius:m});return{min:c,max:d,data:b}};return d.prototype={renderPartial:function(a){this._drawAlpha(a),this._colorize()},renderAll:function(a){this._clear(),this._drawAlpha(c(a)),this._colorize()},_updateGradient:function(b){this._palette=a(b)},updateConfig:function(a){a["gradient"]&&this._updateGradient(a),this._setStyles(a)},setDimensions:function(a,b){this._width=a,this._height=b,this.canvas.width=this.shadowCanvas.width=a,this.canvas.height=this.shadowCanvas.height=b},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(a){this._blur=0==a.blur?0:a.blur||a.defaultBlur,a.backgroundColor&&(this.canvas.style.backgroundColor=a.backgroundColor),this._opacity=255*(a.opacity||0),this._maxOpacity=255*(a.maxOpacity||a.defaultMaxOpacity),this._minOpacity=255*(a.minOpacity||a.defaultMinOpacity),this._useGradientOpacity=!!a.useGradientOpacity},_drawAlpha:function(a){var e,f,g,h,i,j,k,l,m,n,o,c=this._min=a.min,d=this._max=a.max;for(a=a.data||[],e=a.length,f=1-this._blur;e--;)g=a[e],h=g.x,i=g.y,j=g.radius,k=Math.min(g.value,d),l=h-j,m=i-j,n=this.shadowCtx,this._templates[j]?o=this._templates[j]:this._templates[j]=o=b(j,f),n.globalAlpha=(k-c)/(d-c),n.drawImage(o,l,m),l<this._renderBoundaries[0]&&(this._renderBoundaries[0]=l),m<this._renderBoundaries[1]&&(this._renderBoundaries[1]=m),l+2*j>this._renderBoundaries[2]&&(this._renderBoundaries[2]=l+2*j),m+2*j>this._renderBoundaries[3]&&(this._renderBoundaries[3]=m+2*j)},_colorize:function(){var k,l,m,n,o,p,q,r,a=this._renderBoundaries[0],b=this._renderBoundaries[1],c=this._renderBoundaries[2]-a,d=this._renderBoundaries[3]-b,e=this._width,f=this._height,g=this._opacity,h=this._maxOpacity,i=this._minOpacity,j=this._useGradientOpacity;for(0>a&&(a=0),0>b&&(b=0),a+c>e&&(c=e-a),b+d>f&&(d=f-b),k=this.shadowCtx.getImageData(a,b,c,d),l=k.data,m=l.length,n=this._palette,o=3;m>o;o+=4)p=l[o],q=4*p,q&&(r=g>0?g:h>p?i>p?i:p:h,l[o-3]=n[q],l[o-2]=n[q+1],l[o-1]=n[q+2],l[o]=j?n[q+3]:r);k.data=l,this.ctx.putImageData(k,a,b),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(a){var c=this.shadowCtx,d=c.getImageData(a.x,a.y,1,1),e=d.data[3],f=this._max,g=this._min,b=Math.abs(f-g)*(e/255)>>0;return b},getDataURL:function(){return this.canvas.toDataURL()}},d}(),d=function(){var b=!1;return"canvas2d"===a["defaultRenderer"]&&(b=c),b}(),e={merge:function(){var c,d,e,a={},b=arguments.length;for(c=0;b>c;c++){d=arguments[c];for(e in d)a[e]=d[e]}return a}},f=function(){function g(){var h,i,g=this._config=e.merge(a,arguments[0]||{});if(this._coordinator=new c,g["plugin"]){if(h=g["plugin"],!a.plugins[h])throw new Error("Plugin '"+h+"' not found. Maybe it was not registered.");i=a.plugins[h],this._renderer=new i.renderer(g),this._store=new i.store(g)}else this._renderer=new d(g),this._store=new b(g);f(this)}var c=function(){function a(){this.cStore={}}return a.prototype={on:function(a,b,c){var d=this.cStore;d[a]||(d[a]=[]),d[a].push(function(a){return b.call(c,a)})},emit:function(a,b){var d,e,f,c=this.cStore;if(c[a])for(d=c[a].length,e=0;d>e;e++)f=c[a][e],f(b)}},a}(),f=function(a){var b=a._renderer,c=a._coordinator,d=a._store;c.on("renderpartial",b.renderPartial,b),c.on("renderall",b.renderAll,b),c.on("extremachange",function(b){a._config.onExtremaChange&&a._config.onExtremaChange({min:b.min,max:b.max,gradient:a._config["gradient"]||a._config["defaultGradient"]})}),d.setCoordinator(c)};return g.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(a){return this._config=e.merge(this._config,a),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(a){return this._store.getValueAt?this._store.getValueAt(a):this._renderer.getValueAt?this._renderer.getValueAt(a):null}},g}(),g={create:function(a){return new f(a)},register:function(b,c){a.plugins[b]=c}};return g});var BMapLib=window.BMapLib=BMapLib||{};!function(){function b(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))}var a=BMapLib.HeatmapOverlay=function(a){this.conf=a,this.conf.visible=void 0===a.visible?!0:a.visible,this.heatmap=null,this.latlngs=[],this.bounds=null};a.prototype=new BMap.Overlay,a.prototype.initialize=function(a){var c,d;return this._map=a,c=document.createElement("div"),c.style.position="absolute",c.style.top=0,c.style.left=0,c.style.border=0,c.style.width=this._map.getSize().width+"px",c.style.height=this._map.getSize().height+"px",this.conf.element=c,b()?(a.getPanes().mapPane.appendChild(c),this.conf.valueField=this.conf.valueField||"count",this.heatmap=h337.create(this.conf),d=this,a.addEventListener("resize",function(a){var b=a.size;c.style.width=b.width+"px",c.style.height=b.height+"px",d.heatmap._renderer.setDimensions(b.width,b.height),d.draw()}),this._div=c,c):c},a.prototype.draw=function(){var a,c,e,f,g,h,i,j,k,l,m,n;if(b()&&(a=this._map.getBounds(),!a.equals(this.bounds)&&(this.bounds=a,c=this._map.pointToOverlayPixel(a.getNorthEast()),e=this._map.pointToOverlayPixel(a.getSouthWest()),f=c.y,g=e.x,h=e.y-c.y,i=c.x-e.x,this.conf.element.style.left=g+"px",this.conf.element.style.top=f+"px",this.conf.element.style.width=i+"px",this.conf.element.style.height=h+"px",this.latlngs.length>0))){for(this.heatmap.removeData(),j=this.latlngs.length,d={max:this.heatmap._store.getData().max,data:[]};j--;)k=this.latlngs[j].latlng,a.containsPoint(k)&&(l=this._map.pointToOverlayPixel(k),g=this._map.pointToOverlayPixel(a.getSouthWest()).x,f=this._map.pointToOverlayPixel(a.getNorthEast()).y,m=new BMap.Pixel(l.x-g,l.y-f),n=this.pixelTransform(m),d.data.push({x:n.x,y:n.y,count:this.latlngs[j].c}));this.conf.radiusChangeByZoom&&(this.heatmap._store._cfgRadius=this.conf.radiusChangeByZoom(this._map.getZoom())),this.heatmap.setData(d)}},a.prototype.pixelTransform=function(a){for(var b=this.heatmap.width,c=this.heatmap.height;a.x<0;)a.x+=b;for(;a.x>b;)a.x-=b;for(;a.y<0;)a.y+=c;for(;a.y>c;)a.y-=c;return a.x=a.x>>0,a.y=a.y>>0,a},a.prototype.setDataSet=function(a){var c,d,e,f,g,h,i,j,k,l;if(this.data=a,b()){for(c=this._map.getBounds(),d={max:a.max,data:[]},e=a.data,f=e.length,this.latlngs=[],this.heatmap.removeData(),this.conf.radiusChangeByZoom&&(this.heatmap._store._cfgRadius=this.conf.radiusChangeByZoom(this._map.getZoom()));f--;)g=new BMap.Point(e[f].lng,e[f].lat),this.latlngs.push({latlng:g,c:e[f].count}),c.containsPoint(g)&&(h=this._map.pointToOverlayPixel(g),i=this._map.pointToOverlayPixel(c.getSouthWest()).x,j=this._map.pointToOverlayPixel(c.getNorthEast()).y,k=new BMap.Pixel(h.x-i,h.y-j),l=this.pixelTransform(k),d.data.push({x:l.x,y:l.y,count:e[f].count}));this.heatmap.setData(d)}},a.prototype.addDataPoint=function(a,c,d){if(b()){this.data&&this.data.data&&this.data.data.push({lng:a,lat:c,count:d});var e=new BMap.Point(a,c),f=this.pixelTransform(this._map.pointToOverlayPixel(e));this.heatmap.store.addDataPoint(f.x,f.y,d),this.latlngs.push({latlng:e,c:d})}},a.prototype.toggle=function(){b()&&(this.conf.visible=this.conf.visible===!0?!1:!0,this.conf.element.style.display=this.conf.visible?"block":"none")},a.prototype.setOptions=function(a){if(b()){for(var c in a)"radius"==c&&(this.heatmap._store._cfgRadius=a[c]),"opacity"==c&&(a[c]=a[c]/100);this.heatmap.configure(a),this.data&&this.setDataSet(this.data)}}}();